<!doctype html>
<html>
<head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<title>登录收银台</title>
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
	<meta name="format-detection" content="telephone=no" />
	<link rel="stylesheet" type="text/css" href="css/weui.min.css"/>
	<link rel="stylesheet" href="css/receiver.css">
</head>
<body>
<div class="your_phone">
	<h3>请输入<span class="phone">您的手机号</span></h3>
</div>
<div class="put_box">
	<div class="nums">
		<span class="num_title">手机号</span>
		<input class="phone_puts" id="phone" type="text" placeholder="请输入手机号">
	</div>
	<div class="nums secd">
		<span class="num_title secd">验证码</span>
		<input class="phone_puts secd" type="text" id="verify" placeholder="请输入验证码">
		<a href="javascript:;" class="get_code" id="get_code" onclick="send_sms()">获取验证码</a>
	</div>
</div>

<div class="login_dialog_alert" style="display:none;">
			<div class="weui_mask"></div>
			<div class="weui_dialog">
				<div class="weui_dialog_hd"><strong class="weui_dialog_title">弹窗标题</strong></div>
				<div class="weui_dialog_bd">弹窗内容，告知当前页面信息等</div>
				<div class="weui_dialog_ft">
					<a href="#" onclick="CloseLogindlgalert();" class="weui_btn_dialog primary">确定</a>
				</div>
			</div>
		</div>

<div class="btn_cont">
	<a href="javascript:;" class="confirm_btn" onclick="login()">确定</a>
	<a href="javascript:;" class="back_btn" onclick="myhreturn()">返回</a>
</div>
<div class="foot">
	<p>服务热线：020-38217085</p>
</div>
<script type="text/javascript" src="js/jquery-2.0.3.min.js"></script>
<script src="__PUBLIC__/App/script/weuialert.js"></script>
<script type="application/javascript">
	
	//返回按钮，如果是点击退出后，回到登录页，则不让返回
	function myhreturn() {
		var rfv = "<?php echo $_GET['from']; ?>";
		if( rfv == 1) {
			return;
		}
		history.go(-1);
	}
	
	function CloseLogindlgalert() {
		$(".login_dialog_alert").hide();
		setTimeout(function () {
			window.location.href = "{:U('main')}";
		}, 300);
	}
	
	function login () {
		var phone = $("#phone").val();
		var verify = $("#verify").val();
		if (phone == '') {
			Myalert('login_dialog_alert','警告','请输入手机号！'); 
			return;
		}
		var patrn = /^(1(([34578][0-9])|(47)|[8][01256789]))\d{8}$/;
		if (! patrn.exec($.trim(phone))) {
			Myalert('login_dialog_alert','警告','手机号格式错误！');
			return;
		}
		if (verify == '') {
			Myalert('login_dialog_alert','警告','请输入验证码！');
			return;
		}
		$.post("{:U('login')}", {phone: phone, verify: verify},
			  function (data) {
				  var obj = eval("(" + data + ")");
				  if (obj.code == 1) {					  					  
					  localStorage.setItem('shop_id', obj.shop.shop_id);		//门店ID
					  localStorage.setItem('payee_id',obj.shop.id);				//收银员数据表ID
					  localStorage.setItem('tag', obj.shop.shop_id); 			//门店ID
					  localStorage.setItem('agent_id', obj.shop.agent_id); 		//代理商ID
					  localStorage.setItem('saleman_id', obj.shop.saleman_id); 	//业务员ID
					  localStorage.setItem('shop_name', obj.shop.shop_name);	//门店名
					  localStorage.setItem('mch_name', obj.shop.merchant_name);	//商户名称
					  localStorage.setItem('agent_name', obj.shop.agent_name);	//代理商名称
					  localStorage.setItem('sale_name', obj.shop.saleman_name);	//业务员名称					  
					  localStorage.setItem('sub_mchid', obj.shop.sub_mchid);
					  Myalert('login_dialog_alert','提示','登录成功！');
				  } 
				  else if (obj.code == 2) {
					Myalert('login_dialog_alert','警告','您未成为收银员！');					  
				  } 
				  else {
					Myalert('login_dialog_alert','错误','登录失败！');					  
				  }
			  });
	}
	var countdown = 60;
	function get_code ()
	{
		if (countdown == 0) {
			window.clearTimeout(tot);
			//设置按钮为可点
			$("#get_code").attr("onclick", 'send_sms()');
			//背景
			$(".get_code").css("color", '#04be02');
			$(".get_code").css("border", '1px solid #04be02');
			$("#get_code").text("重新发送");
			countdown = 60;
			return;
		} else {
			//设置按钮为不可点
			$("#get_code").attr("onclick", '');
			//背景
			$(".get_code").css("color", '#c2c2c2');
			$(".get_code").css("border", '1px solid #c2c2c2');
			$("#get_code").text("" + countdown + "秒后重发");
			countdown --;
		}
		var tot = setTimeout(function () {
			get_code();
		}, 1000);
	}
	//发送短信验证码
	function send_sms ()
	{
		var sendurl = "{:U('Home/Index/send_sms')}";
		var mobile = $("#phone").val();
		if (mobile == '') {			
			Myalert('login_dialog_alert','警告','请输入手机号！');
			return;
		}
		get_code();			
		$.ajax({
			type: "POST",
			url: sendurl,
			data: "mobile=" + mobile + "",
			dataType: "jsonp",
			jsonp: "callback",
			jsonpCallback: "flightHandler",
			success: function (msg) {
				var dataObj = eval("(" + msg + ")");
				if (dataObj.msg == '短信接口调用成功') {
				} else {
					Myalert('login_dialog_alert','警告','获取验证码失败：' + dataObj.msg);
				}
			},
			error: function (msg) {
				Myalert('login_dialog_alert','警告','登录错误：'+msg);
			}
		});
	}
</script>
</body>
</html>
